<?php

function emic_cwrc_menu() {
  $items = array();
  $items['cwrc/page'] = array(
    'file' => 'emic_cwrc.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cwrc_page_select_form'),
    'type' => MENU_CALLBACK,
    'access arguments' => array('use CWRC'),
  );

  $items['cwrc/save'] = array(
    'file' => 'emic_cwrc.inc',
    'page callback' => 'save_cwrc_data',
    'type' => MENU_CALLBACK,
    'access arguments' => array('use CWRC'),
  );
  $items['cwrc/getCWRC'] = array(
    'file' => 'emic_cwrc.inc',
    'page callback' => 'get_cwrc_data',
    'type' => MENU_CALLBACK,
    'access arguments' => array('use CWRC'),
  );

  $items['cwrc/setupCWRC'] = array(
    'file' => 'emic_cwrc.inc',
    'page callback' => 'setupCWRC',
    'type' => MENU_CALLBACK,
    'access arguments' => array('use CWRC'),
  );
  return $items;
}

function emic_cwrc_perm() {
  return array(
    'use CWRC',
  );
}

function emic_cwrc_form_islandora_book_admin_settings_alter(&$form, &$form_state) {

  $cwrc_path = isset($form_state['values']['islandora_cwrc_path']) ? $form_state['values']['islandora_cwrc_path'] : variable_get('islandora_cwrc_path', 'http://localhost/CWRCEditor/resources/index.php');
  $cwrc_avail = is_url_valid($cwrc_path);
  $confirmation_message = ($cwrc_avail ? '<img src="' . url('misc/watchdog-ok.png') . '"/>'
          . t('CWRCWriter url is valid.') : '<img src="'
          . url('misc/watchdog-error.png') . '"/> '
          . t('Unable to locate CWRCWriter installtion at !tile_path</p>', array('!tile_path' => $cwrc_path)));

  $form['book_ahah_wrapper']['islandora_cwrc_path'] = array(
    '#type' => 'textfield',
    '#title' => t('Path to CWRCWriter'),
    '#description' => t('Path to CWRCWriter installation'),
    '#default_value' => $cwrc_path,
    '#ahah' => array(
      'path' => 'islandora/book/ocr',
      'wrapper' => 'ibook-url',
      'effect' => 'fade',
      'event' => 'change'),
  );

  $form['book_ahah_wrapper']['infobox4'] = array(
    '#type' => 'item',
    '#value' => $confirmation_message,
  );
}


function emic_cwrc_islandora_book_links($pid){
  $cwrc_host = variable_get('islandora_cwrc_path', 'http://localhost/CWRCEditor/resources/index.php');
  $options = array(
           'attributes' => array('target' => '_blank'),
           'query' => array(
                'PID' => $pid . '-001',
            ),
          );
  $link = l('Edit with CWRCWriter', "$cwrc_host", $options);
  return $link;
}
